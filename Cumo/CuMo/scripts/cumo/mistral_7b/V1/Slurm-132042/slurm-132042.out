[2025-06-15 08:39:07,691] [INFO] [real_accelerator.py:158:get_accelerator] Setting ds_accelerator to cuda (auto detect)
[2025-06-15 08:39:09,883] [WARNING] [runner.py:203:fetch_hostfile] Unable to find hostfile, will proceed with training with local resources only.
Detected CUDA_VISIBLE_DEVICES=0: setting --include=localhost:0
[2025-06-15 08:39:09,910] [INFO] [runner.py:570:main] cmd = /cfs/earth/scratch/benkehel/.conda/envs/cumoTorch21/bin/python3.9 -u -m deepspeed.launcher.launch --world_info=eyJsb2NhbGhvc3QiOiBbMF19 --master_addr=127.0.0.1 --master_port=29500 --enable_each_rank_log=None /cfs/earth/scratch/benkehel/CuMo/cumo/train/train_mem.py --deepspeed /cfs/earth/scratch/benkehel/CuMo/scripts/zero3_offload.json --model_name_or_path /cfs/earth/scratch/benkehel/CuMo/checkpoints/CuMo-mistral-7b --version mistral_instruct_system --data_path /cfs/earth/scratch/benkehel/CuMo/data/jsons/train.json --image_folder /cfs/earth/scratch/benkehel/CuMo/data/Fertignummeriert --vision_tower openai/clip-vit-large-patch14-336 --vision_tower_dir /cfs/earth/scratch/benkehel/CuMo/checkpoints/CuMo-mistral-7b/clip.bin --scales 1,3 --pretrain_mm_mlp_adapter /cfs/earth/scratch/benkehel/CuMo/checkpoints/CuMo-mistral-7b/mm_projector.bin --mm_projector_type smoe_mlp --mlp_smoe True --clip_smoe True --num_experts 4 --num_selected 2 --balance_loss_coef 0.1 --router_z_loss_coef 0.01 --mm_vision_select_layer -2 --mm_use_im_start_end False --mm_use_im_patch_token False --image_aspect_ratio pad --group_by_modality_length True --lr_scheduler_type cosine --bf16 True --fp16 False --output_dir /cfs/earth/scratch/benkehel/CuMo/checkpoints/cumo-mistral-7b-sft --num_train_epochs 2 --per_device_train_batch_size 4 --per_device_eval_batch_size 1 --gradient_accumulation_steps 2 --save_strategy steps --save_steps 100 --save_total_limit 5 --learning_rate 4e-6 --weight_decay 0. --logging_steps 1 --tf32 True --model_max_length 4096 --gradient_checkpointing True --dataloader_num_workers 4 --lazy_preprocess True --report_to none
[2025-06-15 08:39:13,021] [INFO] [real_accelerator.py:158:get_accelerator] Setting ds_accelerator to cuda (auto detect)
[2025-06-15 08:39:14,496] [INFO] [launch.py:145:main] WORLD INFO DICT: {'localhost': [0]}
[2025-06-15 08:39:14,497] [INFO] [launch.py:151:main] nnodes=1, num_local_procs=1, node_rank=0
[2025-06-15 08:39:14,497] [INFO] [launch.py:162:main] global_rank_mapping=defaultdict(<class 'list'>, {'localhost': [0]})
[2025-06-15 08:39:14,497] [INFO] [launch.py:163:main] dist_world_size=1
[2025-06-15 08:39:14,497] [INFO] [launch.py:165:main] Setting CUDA_VISIBLE_DEVICES=0
[2025-06-15 08:39:19,033] [INFO] [real_accelerator.py:158:get_accelerator] Setting ds_accelerator to cuda (auto detect)
[2025-06-15 08:39:19,553] [INFO] [comm.py:637:init_distributed] cdb=None
[2025-06-15 08:39:19,553] [INFO] [comm.py:668:init_distributed] Initializing TorchBackend in DeepSpeed with backend nccl
[2025-06-15 08:39:29,600] [INFO] [partition_parameters.py:347:__exit__] finished initializing model - num_params = 684, num_elems = 7.57B
Formatting inputs...Skip in lazy mode
[2025-06-15 08:39:40,844] [INFO] [logging.py:96:log_dist] [Rank 0] DeepSpeed info: version=0.11.1, git-hash=unknown, git-branch=unknown
[2025-06-15 08:39:40,890] [INFO] [logging.py:96:log_dist] [Rank 0] DeepSpeed Flops Profiler Enabled: False
[1/4] /cfs/earth/scratch/benkehel/cuda12.1/toolkit/bin/nvcc  -DTORCH_EXTENSION_NAME=cpu_adam -DTORCH_API_INCLUDE_EXTENSION_H -DPYBIND11_COMPILER_TYPE=\"_gcc\" -DPYBIND11_STDLIB=\"_libstdcpp\" -DPYBIND11_BUILD_ABI=\"_cxxabi1011\" -I/cfs/earth/scratch/benkehel/.conda/envs/cumoTorch21/lib/python3.9/site-packages/deepspeed/ops/csrc/includes -I/cfs/earth/scratch/benkehel/cuda12.1/toolkit/include -isystem /cfs/earth/scratch/benkehel/.conda/envs/cumoTorch21/lib/python3.9/site-packages/torch/include -isystem /cfs/earth/scratch/benkehel/.conda/envs/cumoTorch21/lib/python3.9/site-packages/torch/include/torch/csrc/api/include -isystem /cfs/earth/scratch/benkehel/.conda/envs/cumoTorch21/lib/python3.9/site-packages/torch/include/TH -isystem /cfs/earth/scratch/benkehel/.conda/envs/cumoTorch21/lib/python3.9/site-packages/torch/include/THC -isystem /cfs/earth/scratch/benkehel/cuda12.1/toolkit/include -isystem /cfs/earth/scratch/benkehel/.conda/envs/cumoTorch21/include/python3.9 -D_GLIBCXX_USE_CXX11_ABI=0 -D__CUDA_NO_HALF_OPERATORS__ -D__CUDA_NO_HALF_CONVERSIONS__ -D__CUDA_NO_BFLOAT16_CONVERSIONS__ -D__CUDA_NO_HALF2_OPERATORS__ --expt-relaxed-constexpr -gencode=arch=compute_80,code=compute_80 -gencode=arch=compute_80,code=sm_80 --compiler-options '-fPIC' -O3 --use_fast_math -std=c++17 -U__CUDA_NO_HALF_OPERATORS__ -U__CUDA_NO_HALF_CONVERSIONS__ -U__CUDA_NO_HALF2_OPERATORS__ -gencode=arch=compute_80,code=sm_80 -gencode=arch=compute_80,code=compute_80 -DBF16_AVAILABLE -c /cfs/earth/scratch/benkehel/.conda/envs/cumoTorch21/lib/python3.9/site-packages/deepspeed/ops/csrc/common/custom_cuda_kernel.cu -o custom_cuda_kernel.cuda.o 
[2/4] c++ -MMD -MF cpu_adam.o.d -DTORCH_EXTENSION_NAME=cpu_adam -DTORCH_API_INCLUDE_EXTENSION_H -DPYBIND11_COMPILER_TYPE=\"_gcc\" -DPYBIND11_STDLIB=\"_libstdcpp\" -DPYBIND11_BUILD_ABI=\"_cxxabi1011\" -I/cfs/earth/scratch/benkehel/.conda/envs/cumoTorch21/lib/python3.9/site-packages/deepspeed/ops/csrc/includes -I/cfs/earth/scratch/benkehel/cuda12.1/toolkit/include -isystem /cfs/earth/scratch/benkehel/.conda/envs/cumoTorch21/lib/python3.9/site-packages/torch/include -isystem /cfs/earth/scratch/benkehel/.conda/envs/cumoTorch21/lib/python3.9/site-packages/torch/include/torch/csrc/api/include -isystem /cfs/earth/scratch/benkehel/.conda/envs/cumoTorch21/lib/python3.9/site-packages/torch/include/TH -isystem /cfs/earth/scratch/benkehel/.conda/envs/cumoTorch21/lib/python3.9/site-packages/torch/include/THC -isystem /cfs/earth/scratch/benkehel/cuda12.1/toolkit/include -isystem /cfs/earth/scratch/benkehel/.conda/envs/cumoTorch21/include/python3.9 -D_GLIBCXX_USE_CXX11_ABI=0 -fPIC -std=c++17 -O3 -std=c++17 -g -Wno-reorder -L/cfs/earth/scratch/benkehel/cuda12.1/toolkit/lib64 -lcudart -lcublas -g -march=native -fopenmp -D__AVX512__ -D__ENABLE_CUDA__ -DBF16_AVAILABLE -c /cfs/earth/scratch/benkehel/.conda/envs/cumoTorch21/lib/python3.9/site-packages/deepspeed/ops/csrc/adam/cpu_adam.cpp -o cpu_adam.o 
[3/4] c++ -MMD -MF cpu_adam_impl.o.d -DTORCH_EXTENSION_NAME=cpu_adam -DTORCH_API_INCLUDE_EXTENSION_H -DPYBIND11_COMPILER_TYPE=\"_gcc\" -DPYBIND11_STDLIB=\"_libstdcpp\" -DPYBIND11_BUILD_ABI=\"_cxxabi1011\" -I/cfs/earth/scratch/benkehel/.conda/envs/cumoTorch21/lib/python3.9/site-packages/deepspeed/ops/csrc/includes -I/cfs/earth/scratch/benkehel/cuda12.1/toolkit/include -isystem /cfs/earth/scratch/benkehel/.conda/envs/cumoTorch21/lib/python3.9/site-packages/torch/include -isystem /cfs/earth/scratch/benkehel/.conda/envs/cumoTorch21/lib/python3.9/site-packages/torch/include/torch/csrc/api/include -isystem /cfs/earth/scratch/benkehel/.conda/envs/cumoTorch21/lib/python3.9/site-packages/torch/include/TH -isystem /cfs/earth/scratch/benkehel/.conda/envs/cumoTorch21/lib/python3.9/site-packages/torch/include/THC -isystem /cfs/earth/scratch/benkehel/cuda12.1/toolkit/include -isystem /cfs/earth/scratch/benkehel/.conda/envs/cumoTorch21/include/python3.9 -D_GLIBCXX_USE_CXX11_ABI=0 -fPIC -std=c++17 -O3 -std=c++17 -g -Wno-reorder -L/cfs/earth/scratch/benkehel/cuda12.1/toolkit/lib64 -lcudart -lcublas -g -march=native -fopenmp -D__AVX512__ -D__ENABLE_CUDA__ -DBF16_AVAILABLE -c /cfs/earth/scratch/benkehel/.conda/envs/cumoTorch21/lib/python3.9/site-packages/deepspeed/ops/csrc/adam/cpu_adam_impl.cpp -o cpu_adam_impl.o 
[4/4] c++ cpu_adam.o cpu_adam_impl.o custom_cuda_kernel.cuda.o -shared -lcurand -L/cfs/earth/scratch/benkehel/.conda/envs/cumoTorch21/lib/python3.9/site-packages/torch/lib -lc10 -lc10_cuda -ltorch_cpu -ltorch_cuda -ltorch -ltorch_python -L/cfs/earth/scratch/benkehel/cuda12.1/toolkit/lib64 -lcudart -o cpu_adam.so
Time to load cpu_adam op: 100.68433237075806 seconds
Adam Optimizer #0 is created with AVX512 arithmetic capability.
Config: alpha=0.000004, betas=(0.900000, 0.999000), weight_decay=0.000000, adam_w=1
[2025-06-15 08:41:22,618] [INFO] [logging.py:96:log_dist] [Rank 0] Using DeepSpeed Optimizer param name adamw as basic optimizer
[2025-06-15 08:41:22,618] [INFO] [logging.py:96:log_dist] [Rank 0] Removing param_group that has no 'params' in the basic Optimizer
[2025-06-15 08:41:22,728] [INFO] [logging.py:96:log_dist] [Rank 0] DeepSpeed Basic Optimizer = DeepSpeedCPUAdam
[2025-06-15 08:41:22,729] [INFO] [utils.py:56:is_zero_supported_optimizer] Checking ZeRO support for optimizer=DeepSpeedCPUAdam type=<class 'deepspeed.ops.adam.cpu_adam.DeepSpeedCPUAdam'>
[2025-06-15 08:41:22,729] [INFO] [logging.py:96:log_dist] [Rank 0] Creating fp16 ZeRO stage 3 optimizer, MiCS is enabled False, Hierarchical params gather False
[2025-06-15 08:41:22,729] [INFO] [logging.py:96:log_dist] [Rank 0] Creating torch.bfloat16 ZeRO stage 3 optimizer
[2025-06-15 08:41:22,806] [INFO] [utils.py:802:see_memory_usage] Stage 3 initialize beginning
[2025-06-15 08:41:22,808] [INFO] [utils.py:803:see_memory_usage] MA 2.19 GB         Max_MA 2.19 GB         CA 2.29 GB         Max_CA 2 GB 
[2025-06-15 08:41:22,808] [INFO] [utils.py:810:see_memory_usage] CPU Virtual Memory:  used = 32.75 GB, percent = 6.5%
[2025-06-15 08:41:22,811] [INFO] [stage3.py:126:__init__] Reduce bucket size 16777216
[2025-06-15 08:41:22,812] [INFO] [stage3.py:127:__init__] Prefetch bucket size 15099494
[2025-06-15 08:41:22,874] [INFO] [utils.py:802:see_memory_usage] DeepSpeedZeRoOffload initialize [begin]
[2025-06-15 08:41:22,875] [INFO] [utils.py:803:see_memory_usage] MA 2.19 GB         Max_MA 2.19 GB         CA 2.29 GB         Max_CA 2 GB 
[2025-06-15 08:41:22,876] [INFO] [utils.py:810:see_memory_usage] CPU Virtual Memory:  used = 32.73 GB, percent = 6.5%
Parameter Offload: Total persistent parameters: 1096704 in 485 params
[2025-06-15 08:41:24,508] [INFO] [utils.py:802:see_memory_usage] DeepSpeedZeRoOffload initialize [end]
[2025-06-15 08:41:24,509] [INFO] [utils.py:803:see_memory_usage] MA 0.5 GB         Max_MA 2.19 GB         CA 2.29 GB         Max_CA 2 GB 
[2025-06-15 08:41:24,510] [INFO] [utils.py:810:see_memory_usage] CPU Virtual Memory:  used = 34.07 GB, percent = 6.8%
[2025-06-15 08:41:24,583] [INFO] [utils.py:802:see_memory_usage] Before creating fp16 partitions
[2025-06-15 08:41:24,584] [INFO] [utils.py:803:see_memory_usage] MA 0.5 GB         Max_MA 0.5 GB         CA 2.29 GB         Max_CA 2 GB 
[2025-06-15 08:41:24,585] [INFO] [utils.py:810:see_memory_usage] CPU Virtual Memory:  used = 34.07 GB, percent = 6.8%
[2025-06-15 08:41:30,542] [INFO] [utils.py:802:see_memory_usage] After creating fp16 partitions: 8
[2025-06-15 08:41:30,544] [INFO] [utils.py:803:see_memory_usage] MA 0.5 GB         Max_MA 0.5 GB         CA 2.29 GB         Max_CA 2 GB 
[2025-06-15 08:41:30,545] [INFO] [utils.py:810:see_memory_usage] CPU Virtual Memory:  used = 50.47 GB, percent = 10.0%
[2025-06-15 08:41:30,617] [INFO] [utils.py:802:see_memory_usage] Before creating fp32 partitions
[2025-06-15 08:41:30,619] [INFO] [utils.py:803:see_memory_usage] MA 0.5 GB         Max_MA 0.5 GB         CA 2.29 GB         Max_CA 2 GB 
[2025-06-15 08:41:30,619] [INFO] [utils.py:810:see_memory_usage] CPU Virtual Memory:  used = 50.46 GB, percent = 10.0%
[2025-06-15 08:41:33,255] [INFO] [utils.py:802:see_memory_usage] After creating fp32 partitions
[2025-06-15 08:41:33,256] [INFO] [utils.py:803:see_memory_usage] MA 0.5 GB         Max_MA 0.5 GB         CA 2.29 GB         Max_CA 2 GB 
[2025-06-15 08:41:33,256] [INFO] [utils.py:810:see_memory_usage] CPU Virtual Memory:  used = 81.28 GB, percent = 16.1%
[2025-06-15 08:41:33,328] [INFO] [utils.py:802:see_memory_usage] Before initializing optimizer states
[2025-06-15 08:41:33,329] [INFO] [utils.py:803:see_memory_usage] MA 0.5 GB         Max_MA 0.5 GB         CA 2.29 GB         Max_CA 2 GB 
[2025-06-15 08:41:33,330] [INFO] [utils.py:810:see_memory_usage] CPU Virtual Memory:  used = 81.29 GB, percent = 16.2%
[2025-06-15 08:41:53,889] [INFO] [utils.py:802:see_memory_usage] After initializing optimizer states
[2025-06-15 08:41:53,890] [INFO] [utils.py:803:see_memory_usage] MA 0.5 GB         Max_MA 0.5 GB         CA 2.29 GB         Max_CA 2 GB 
[2025-06-15 08:41:53,891] [INFO] [utils.py:810:see_memory_usage] CPU Virtual Memory:  used = 179.81 GB, percent = 35.7%
[2025-06-15 08:41:53,891] [INFO] [stage3.py:459:_setup_for_real_optimizer] optimizer state initialized
[2025-06-15 08:42:01,668] [INFO] [utils.py:802:see_memory_usage] After initializing ZeRO optimizer
[2025-06-15 08:42:01,669] [INFO] [utils.py:803:see_memory_usage] MA 0.53 GB         Max_MA 1.02 GB         CA 2.29 GB         Max_CA 2 GB 
[2025-06-15 08:42:01,669] [INFO] [utils.py:810:see_memory_usage] CPU Virtual Memory:  used = 196.09 GB, percent = 39.0%
[2025-06-15 08:42:01,669] [INFO] [logging.py:96:log_dist] [Rank 0] DeepSpeed Final Optimizer = adamw
[2025-06-15 08:42:16,692] [INFO] [launch.py:315:sigkill_handler] Killing subprocess 1374836
[2025-06-15 08:42:16,693] [ERROR] [launch.py:321:sigkill_handler] ['/cfs/earth/scratch/benkehel/.conda/envs/cumoTorch21/bin/python3.9', '-u', '/cfs/earth/scratch/benkehel/CuMo/cumo/train/train_mem.py', '--local_rank=0', '--deepspeed', '/cfs/earth/scratch/benkehel/CuMo/scripts/zero3_offload.json', '--model_name_or_path', '/cfs/earth/scratch/benkehel/CuMo/checkpoints/CuMo-mistral-7b', '--version', 'mistral_instruct_system', '--data_path', '/cfs/earth/scratch/benkehel/CuMo/data/jsons/train.json', '--image_folder', '/cfs/earth/scratch/benkehel/CuMo/data/Fertignummeriert', '--vision_tower', 'openai/clip-vit-large-patch14-336', '--vision_tower_dir', '/cfs/earth/scratch/benkehel/CuMo/checkpoints/CuMo-mistral-7b/clip.bin', '--scales', '1,3', '--pretrain_mm_mlp_adapter', '/cfs/earth/scratch/benkehel/CuMo/checkpoints/CuMo-mistral-7b/mm_projector.bin', '--mm_projector_type', 'smoe_mlp', '--mlp_smoe', 'True', '--clip_smoe', 'True', '--num_experts', '4', '--num_selected', '2', '--balance_loss_coef', '0.1', '--router_z_loss_coef', '0.01', '--mm_vision_select_layer', '-2', '--mm_use_im_start_end', 'False', '--mm_use_im_patch_token', 'False', '--image_aspect_ratio', 'pad', '--group_by_modality_length', 'True', '--lr_scheduler_type', 'cosine', '--bf16', 'True', '--fp16', 'False', '--output_dir', '/cfs/earth/scratch/benkehel/CuMo/checkpoints/cumo-mistral-7b-sft', '--num_train_epochs', '2', '--per_device_train_batch_size', '4', '--per_device_eval_batch_size', '1', '--gradient_accumulation_steps', '2', '--save_strategy', 'steps', '--save_steps', '100', '--save_total_limit', '5', '--learning_rate', '4e-6', '--weight_decay', '0.', '--logging_steps', '1', '--tf32', 'True', '--model_max_length', '4096', '--gradient_checkpointing', 'True', '--dataloader_num_workers', '4', '--lazy_preprocess', 'True', '--report_to', 'none'] exits with return code = 1
